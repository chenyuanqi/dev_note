
### 分表分库
中大型项目中，一旦遇到数据量比较大，都知道应该对数据进行拆分了。  

数据库的拆分有垂直和水平两种。  
垂直拆分比较简单，也就是本来一个数据库，数据量大之后，从业务角度进行拆分多个库。比如，订单使用 order 数据库，日志使用 log 数据库等。  
水平拆分的概念，是同一个业务数据量大之后，进行水平拆分。mysql 单表存储量推荐是百万级，如果不进行处理，mysql 单表数据太大，会导致性能变慢。也可以分库，再分表，把压力从数据库层级分开。  

### 分表前的查询思考
0、 根据自增长 ID 拆表  
关系非常简单，并且有时效性的情况下可以用。

1、根据业务属性拆表，业务关系复杂的情况下，如果要根据其他条件查询，其他的条件都必须和这个属性关联起来，查询条件必须带有这个属性。  

2、根据某个条件查询时无法获取拆表的属性解决方案  
1)条件中含有分表的信息  
比如用户在某网站下了订单，我们根据用户 ID 对订单进行了分表，这样用户可以方便地查询他所关联的订单。但用户投诉时，客服需要根据订单号查询订单，订单号中可以含有分表的信息，比如订单拆分成 100 张表，订单号中可以有两位用来表明该订单处于哪张表中   
2)数据冗余  
需要关联的表可以进行数据冗余，避免查询。 
比如购买虚拟礼品时，我们根据了购买者的 ID 进行了拆表，同时订单号中也含有了分表信息。但是用户还可能根据被赠送方进行查询，这时我们可以在购买成功后为被赠送方冗余生成一条记录。  
3)缓存
和数据冗余类似，可以用缓存的方式存储最近的应用信息。  

3、根据时间拆表  
当表的关系比较复杂时，无法根据某个维度进行分表，但是有明显的时效性。  
比如微博是有很强的时效性的，大部分情况下都是查近三个月的微博，所以近 1 年的微博我们可以存储在物理资源比较好的数据库服务器上。  

4、数据迁移的方式  
当一些很久之前的数据，很少再查询。  
比如员工工资表，可以只存今年的工资情况，而历史数据可以迁移到一张 salary_histories 表中，保证数据不会丢失，但也可以用来查询。  

5、查询分表的优化  
基本查询方案：对每个数据库进行循环查询，然后返回每个数据表符合查询条件的数据，并且将查询到的数据合并到一个数组中。  
升级版查询方案：Union all 组合查询，并进行分页  
针对这样的查询：
1)有损服务，只给查一年内的数据，或者只存 1000w 条数据。建一个表存一年内的数据，每隔一个月把表最旧的数据迁到分表上面，需要查所有数据只能根据年份去查。  
2)组合查询前，先由筛选条件算出所有年份的总数，再根据分页确定要查询所在的年份或者由多个年份组合而来。历史年份的数据还可以考虑 cache 缓存筛选条件下的总数。

### 分库分表方案
分库分表方案中有常用的方案，hash 取模和 range 范围方案。分库分表方案最主要就是路由算法，把路由的 key 按照指定的算法进行路由存放。  

hash 取模：对指定的路由 key（如：id）对分表总数进行取模。比如拆分一个订单表为 5，那么根据 id % 5 得到的值分别存到相应的表中。
优点：  
数据可以均匀放到分表中，不会有热点问题（对订单进行操作集中到 1 个表中，其他表的操作很少）。  
但是，订单有个特点就是时间属性，一般用户操作订单数据，都会集中到这段时间产生的订单。如果这段时间产生的订单 都在同一张订单表中，那就会形成热点，那这张表的压力会比较大。  
缺点：  
将来的数据迁移和扩容，会很难。  
比如业务发展很好，订单量很大，超出了 5000 万订单量，需要增加分表数，那么取模的基数就会变，导致以前的数据查不到。这时候可以考虑数据迁移，但是工作量不小。  

range 范围：以范围进行拆分数据，前期需要把表的范围设计好，通过 id 进行路由存放。比如单表数据量约定为 1000 万，那么第二张表的范围就是 1000 万到 2000 万，以此类推。  
优点：  
有利于将来的扩容，不需要做数据迁移。  
缺点：  
存在热点问题。  

折中方案：hash + range。引入分组 group、db 和 table，group 和 table 控制 range 的范围，db 控制 hash 的取模（基数是 table 的数量，hash 值为 table_id）。  
```
# group 设定
group_id: 1
group_name: group01
start_id: 0
end_id: 5000万

# group 与 db 关系
db_id: 1
db_name: db01
group_id: 1
hash_value: 0,1,2,3

# table 与 db 关系
table_id: 1
table_name: tabel00
db_id: db01
start_id: 0
end_id: 10000万
```
此时，扩容就根据 group 进行扩容 db 和 table 即可，group、db 和 table 的关系可以存放缓存中，这样就不会影响性能了。  

### Mycat 数据库中间件
[Mycat 官网](http://www.mycat.io/)  
[Mycat 源码](https://github.com/MyCATApache/Mycat-Server)    
[Mycat 文档](https://github.com/MyCATApache/Mycat-doc)  

Mycat 是一个开源的分布式数据库系统。  
Mycat 是数据库中间件，就是介于数据库与应用之间，进行数据处理与交互的中间服务。由于前面讲的对数据进行分片处理之后，从原有的一个库，被切分为多个分片数据库，所有的分片数据库集群构成了整个完整的数据库存储。  
数据被分到多个分片数据库后，应用如果需要读取数据，就要需要处理多个数据源的数据。如果没有数据库中间件，那么应用将直接面对分片集群，数据源切换、事务处理、数据聚合都需要应用直接处理，原本该是专注于业务的应用，将会花大量的工作来处理分片后的问题，最重要的是每个应用处理将是完全的重复造轮子。所以有了数据库中间件，应用只需要集中与业务处理，大量的通用的数据聚合，事务，数据源切换都由中间件来处理，中间件的性能与处理能力将直接决定应用的读写性能，所以一款好的数据库中间件至关重要。  

Mycat 的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的 SQL 语句，首先对 SQL 语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。  

Mycat 快速入门
```bash
# MyCAT 是使用 JAVA 语言进行编写开发，使用前需要先安装 JAVA 运行环境（>=jdk7）
# http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html  
# 安装 mysql
# http://dev.mysql.com/downloads/mysql/5.5.html#downloads
# 
# 下载 Mycat： http://dl.mycat.io/ 挑选合适版本下载
wget http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz
tar -xzvf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz Mycat
# 配置 mysql 支持表名大小写（/etc/my.cnf）
# lower_case_table_names=1
# 重启 mysql
# service mysqld restart
# 
# 配置所有 mysql 服务器 host（/etc/hosts）
# 配置 mycat 主机信息
# ...
# 
# 启动 Mycat（console | start | stop | restart | status | dump）
cd Mycat
chmod +x ./bin/mycat
./bin/mycat start
```
MyCAT 目前主要通过配置文件的方式来定义逻辑库和相关配置：  
> MYCAT_HOME/conf/schema.xml中定义逻辑库，表、分片节点等内容；  
> MYCAT_HOME/conf/rule.xml中定义分片规则；  
> MYCAT_HOME/conf/server.xml中定义用户以及系统相关变量，如端口等。  

`DirectBuffer 内存不够，则可以再加 JVM 系统参数：XX:MaxDirectMemorySize=128M`  
